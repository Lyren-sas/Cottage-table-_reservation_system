{% extends "base.html" %}

{% block title %}Add New Cottage - Balugan Cottage{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Add New Cottage</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="mb-6 p-4 rounded-md {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}" id="flash-msg">
            {{ message }}
        </div>
        {% endfor %}
        
        <script>
            setTimeout(function() {
                const flashMsg = document.getElementById("flash-msg");
                if (flashMsg) {
                    flashMsg.remove();
                }
            }, 5000);
        </script>
    {% endif %}
    {% endwith %}
    
    <div class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200">
        <form action="{{ url_for('cottages.add_cottage') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cottage Number -->
                <div>
                    <label for="cottage_no" class="block text-gray-700 font-medium mb-2">Cottage Number *</label>
                    <input type="text" id="cottage_no" name="cottage_no" required 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Flag Color -->
                <div>
                    <label for="flag_color" class="block text-gray-700 font-medium mb-2">Flag Color *</label>
                    <select id="flag_color" name="flag_color" required 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        onchange="toggleColorInput()">
                        <option value="">Select Flag Color</option>
                        <option value="Blue">Blue</option>
                        <option value="Green">Green</option>
                        <option value="Red">Red</option>
                        <option value="Yellow">Yellow</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- New Color (shows only when "Other" is selected) -->
                <div id="other_color_div" class="hidden">
                    <label for="new_color" class="block text-gray-700 font-medium mb-2">Specify Flag Color *</label>
                    <input type="text" id="new_color" name="new_color" 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Cottage Location -->
                <div>
                    <label for="cottage_location" class="block text-gray-700 font-medium mb-2">Cottage Location</label>
                    <input type="text" id="cottage_location" name="cottage_location" 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Beachfront, Pool side, etc.">
                </div>
            </div>
            
            <!-- Cottage Image -->
            <div>
                <label for="cottage_image" class="block text-gray-700 font-medium mb-2">Cottage Image</label>
                <input type="file" id="cottage_image" name="cottage_image" accept="image/*" 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-1">Upload an image of the cottage (PNG, JPG, JPEG, GIF)</p>
            </div>
            
            <!-- Cottage Description -->
            <div>
                <label for="cottage_description" class="block text-gray-700 font-medium mb-2">Cottage Description</label>
                <textarea id="cottage_description" name="cottage_description" rows="4"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Describe the cottage features, amenities, etc."></textarea>
            </div>
            
            <!-- Tables Section -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Tables</h3>
                <p class="text-gray-600 mb-4">Add tables to this cottage (optional)</p>
                
                <div id="new-tables-container" class="space-y-4">
                    <!-- Tables will be added here dynamically -->
                </div>
                
                <input type="hidden" id="new_table_count" name="new_table_count" value="0">
                
                <div class="mt-4">
                    <button type="button" id="add-new-table-btn" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-plus mr-2"></i> Add Table
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between pt-6 border-t border-gray-200">
                <a href="{{ url_for('cottages.my_cottages') }}" 
                    class="bg-gray-600 hover:bg-black text-white px-6 py-2 rounded-lg transition duration-300">
                    Cancel
                </a>
                <button type="submit" class="bg-green-600 hover:bg-black text-white px-6 py-2 rounded-lg transition duration-300">
                    Save Cottage
                </button>
            </div>  
        </form>
    </div>
</div>

<script>
    // Show/hide new color input when "Other" is selected
    function toggleColorInput() {
        const flagColor = document.getElementById('flag_color').value;
        const otherColorDiv = document.getElementById('other_color_div');
        
        if (flagColor === 'Other') {
            otherColorDiv.classList.remove('hidden');
        } else {
            otherColorDiv.classList.add('hidden');
        }
    }
    
    // Tables management
    document.addEventListener('DOMContentLoaded', function() {
        const addNewTableBtn = document.getElementById('add-new-table-btn');
        const newTablesContainer = document.getElementById('new-tables-container');
        const newTableCountInput = document.getElementById('new_table_count');
        
        let newTableCount = 0;
        
        addNewTableBtn.addEventListener('click', function() {
            newTableCount++;
            newTableCountInput.value = newTableCount;
            
            const newTableRow = document.createElement('div');
            newTableRow.className = 'new-table-row grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-4 pb-4 border-b';
            newTableRow.id = `new-table-row-${newTableCount-1}`;
            
            newTableRow.innerHTML = `
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Table Number *</label>
                    <input type="text" name="new_table_no_${newTableCount-1}" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Capacity (Persons) *</label>
                    <input type="number" name="new_table_capacity_${newTableCount-1}" class="w-full px-4 py-2 border rounded-lg" required min="1">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Table Image</label>
                    <input type="file" name="new_table_image_${newTableCount-1}" class="w-full px-4 py-2 border rounded-lg" accept="image/*">
                    <p class="text-sm text-gray-500 mt-1">Upload an image of the table (optional)</p>
                </div>
                
                <div class="flex items-end">
                    <button type="button" class="remove-new-table-btn bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" 
                            data-index="${newTableCount-1}">
                        Remove
                    </button>
                </div>
            `;
            
            newTablesContainer.appendChild(newTableRow);
            
            // Add event listener to the newly created remove button
            const removeBtn = newTableRow.querySelector('.remove-new-table-btn');
            removeBtn.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                const rowToRemove = document.getElementById(`new-table-row-${index}`);
                if (rowToRemove) {
                    rowToRemove.remove();
                }
            });
        });
        
        // Form submission validation
        document.querySelector('form').addEventListener('submit', function(event) {
            const flagColor = document.getElementById('flag_color').value;
            
            if (flagColor === 'Other') {
                const newColor = document.getElementById('new_color').value.trim();
                if (!newColor) {
                    event.preventDefault();
                    alert('Please specify a flag color when selecting "Other".');
                    return;
                }
            }
            
            // We don't need additional validation here as we're using the required attribute on inputs
        });
    });
</script>
{% endblock %}